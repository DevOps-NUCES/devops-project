# Build stage
FROM amazoncorretto:21-alpine-jdk AS build

ARG MONGODB_HOST=mongodb
ARG MONGODB_PORT=27017
ARG MONGODB_DATABASE=purely_product_service
ARG PRODUCT_SERVICE_PORT=9010
ARG SERVICE_REGISTRY_HOSTNAME=localhost
ARG SERVICE_REGISTRY_SERVICE_URL=http://localhost:8761/eureka/

ENV MONGODB_HOST=${MONGODB_HOST}
ENV MONGODB_PORT=${MONGODB_PORT}
ENV MONGODB_DATABASE=${MONGODB_DATABASE}
ENV PRODUCT_SERVICE_PORT=${PRODUCT_SERVICE_PORT}
ENV SERVICE_REGISTRY_HOSTNAME=${SERVICE_REGISTRY_HOSTNAME}
ENV SERVICE_REGISTRY_SERVICE_URL=${SERVICE_REGISTRY_SERVICE_URL}

RUN apk add --no-cache maven
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# Runtime stage
FROM amazoncorretto:21-alpine-jdk

ARG MONGODB_HOST=mongodb
ARG MONGODB_PORT=27017
ARG MONGODB_DATABASE=purely_product_service
ARG PRODUCT_SERVICE_PORT=9010
ARG SERVICE_REGISTRY_HOSTNAME=localhost
ARG SERVICE_REGISTRY_SERVICE_URL=http://localhost:8761/eureka/

ENV MONGODB_HOST=${MONGODB_HOST}
ENV MONGODB_PORT=${MONGODB_PORT}
ENV MONGODB_DATABASE=${MONGODB_DATABASE}
ENV PRODUCT_SERVICE_PORT=${PRODUCT_SERVICE_PORT}
ENV SERVICE_REGISTRY_HOSTNAME=${SERVICE_REGISTRY_HOSTNAME}
ENV SERVICE_REGISTRY_SERVICE_URL=${SERVICE_REGISTRY_SERVICE_URL}

WORKDIR /app
COPY --from=build /app/target/*.jar app.jar
EXPOSE 9010
ENTRYPOINT ["java", "-jar", "app.jar"]