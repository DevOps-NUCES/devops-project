# Build stage
FROM amazoncorretto:17-alpine-jdk AS build
ARG NOTIFICATION_SERVICE_PORT=9020
ARG SMTP_SERVER_URL=smtp.gmail.com
ARG SMTP_SERVER_PORT=587
ARG EMAIL_USERNAME=yourusername@gmail.com
ARG EMAIL_PASSWORD=yourpassword
ARG SERVICE_REGISTRY_HOSTNAME=localhost
ARG SERVICE_REGISTRY_SERVICE_URL=http://localhost:8761/eureka/

ENV SMTP_SERVER_URL=$SMTP_SERVER_URL
ENV SMTP_SERVER_PORT=$SMTP_SERVER_PORT
ENV EMAIL_USERNAME=$EMAIL_USERNAME
ENV EMAIL_PASSWORD=$EMAIL_PASSWORD
ENV SERVICE_REGISTRY_HOSTNAME=$SERVICE_REGISTRY_HOSTNAME
ENV SERVICE_REGISTRY_SERVICE_URL=$SERVICE_REGISTRY_SERVICE_URL
ENV NOTIFICATION_SERVICE_PORT=$NOTIFICATION_SERVICE_PORT

RUN apk add --no-cache maven
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

# Runtime stage
FROM amazoncorretto:17-alpine-jdk
ARG NOTIFICATION_SERVICE_PORT=9020
ARG SMTP_SERVER_URL=smtp.gmail.com
ARG SMTP_SERVER_PORT=587
ARG EMAIL_USERNAME=yourusername@gmail.com
ARG EMAIL_PASSWORD=yourpassword
ARG SERVICE_REGISTRY_HOSTNAME=localhost
ARG SERVICE_REGISTRY_SERVICE_URL=http://localhost:8761/eureka/

ENV SMTP_SERVER_URL=$SMTP_SERVER_URL
ENV SMTP_SERVER_PORT=$SMTP_SERVER_PORT
ENV EMAIL_USERNAME=$EMAIL_USERNAME
ENV EMAIL_PASSWORD=$EMAIL_PASSWORD
ENV SERVICE_REGISTRY_HOSTNAME=$SERVICE_REGISTRY_HOSTNAME
ENV SERVICE_REGISTRY_SERVICE_URL=$SERVICE_REGISTRY_SERVICE_URL
ENV NOTIFICATION_SERVICE_PORT=$NOTIFICATION_SERVICE_PORT

WORKDIR /app
COPY --from=build /app/target/*.jar app.jar
EXPOSE ${NOTIFICATION_SERVICE_PORT}
ENTRYPOINT ["java", "-jar", "app.jar"]